{% set no_robots = True %}
{% set user_change_requires_refresh = True %}

{% extends "layout.html" %}

{% block title %}Edit Group: {{ group.group_name }}{% endblock %}

{% block head %}
    {{ super() }}
    <script>
        var allUsers = {{ all_users|tojson }};
        var allUsersMap = {};
        allUsers.forEach(function(currUser) {
            allUsersMap[currUser.email_address] = currUser;
        });
        var groupUsers = {{ group_users|tojson }};

        /**
         * Sorts users by email address and removes duplicates returning the result
         */
        function normalizeUsers(users) {
            var sortedUsers = users.slice().sort(function(user1, user2) {
                return user1.email_address.localeCompare(user2.email_address);
            });

            var uniqueUsers = [];
            var prevUser = null;
            sortedUsers.forEach(function(user) {
                // we should only push users that have a unique email address which is
                // present in the allUsersMap
                var doPush =
                        user.email_address in allUsersMap &&
                        (prevUser === null || user.email_address !== prevUser.email_address)
                if(doPush) {
                    uniqueUsers.push(user)
                }

                prevUser = user;
            });

            return uniqueUsers;
        }

        $(function() {
            groupUsers = normalizeUsers(groupUsers);

            var addUsersInput = $('#add-users-input');
            addUsersInput.tokenfield({
                autocomplete: {
                    source: allUsers.map(function(currUser) {
                        return {
                            label: currUser.email_address,
                            value: currUser.id
                        };
                    }),
                    delay: 100,
                    autoFocus: true
                },
                createTokensOnBlur: true
            });
            addUsersInput.on('tokenfield:createtoken', function(e) {
                // only accept token creation for known users
                return e.attrs.value in allUsersMap;
            });

            var addUsersButton = $('#add-users-button');
            addUsersButton.click(function() {
                addUsersInput.tokenfield('getTokens').forEach(function(currToken) {
                    groupUsers.push({
                        email_address: currToken.label,
                        id: currToken.value
                    });
                    groupUsers = normalizeUsers(groupUsers);
                });
                rebuildGroupTable();
            });

            function rebuildGroupTable() {
                groupUsers.forEach(function(user) {
                    var nameTd = $(document.createElement('td'));
                    var rmUserButton = $(
                            '<button type="button" class="btn btn-default btn-sm" title="remove ' + $.text(user) + ' from group">' +
                            '<span class="fa fa-user-times" aria-hidden="true"></span>' +
                            '</button>');
                    nameTd.append(document.createTextNode(user.email_address));

                    var tr = $(document.createElement('tr'));
                });
            }
            rebuildGroupTable();

            $('[data-toggle="tooltip"]').tooltip()
        });
    </script>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Group: {{ group.group_name }}</h1>
    </div>

    <div style="margin-bottom: 10px;">
        <button id="save-group-button" type="button" class="btn btn-primary">
            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Save Edits
        </button>
        <a href="{{ url_for('group_html', group_name=group.group_name) }}" class="btn btn-default">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel Edits
        </a>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="input-group">
                <input id="add-users-input" type="text" class="form-control" placeholder="user1@example.com, user2@example.com, ..."/>
                <span class="input-group-btn">
                    <button id="add-users-button" class="btn btn-default" type="button"><span class="fa fa-user-plus"></span> Add Users to Group</button>
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Group Member email</th>
                        <th>Administrator</th>
                    </tr>
                </thead>
                <tbody id="group-users-tbody">
                {#
                {% for group_user in group_users %}
                    <tr>
                        <td>
                            <button type="button" class="btn btn-default btn-sm" title="remove {{ group_user.email_address }} from group">
                                <span class="fa fa-user-times" aria-hidden="true"></span>
                            </button>
                            {{ group_user.email_address }}
                        </td>
                        <td>{% if group_user.is_group_admin %}<span class="glyphicon glyphicon-ok" aria-label="{{ group_user.email_address }} is an administrator"></span>{% endif %}</td>
                    </tr>
                {% endfor %}
                #}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
